---
- name: Create new Linux user with SSH key and shell
  hosts: all
  become: yes

  tasks:

    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - new_user is defined
          - user_shell is defined
          - user_ssh_key is defined

    - name: Ensure primary group exists
      ansible.builtin.group:
        name: "{{ new_user }}"
        gid: "{{ user_gid }}"
        state: present

    - name: Ensure user "{{ new_user }}" exists
      ansible.builtin.user:
        name: "{{ new_user }}"
        uid: "{{ user_uid }}"
        group: "{{ new_user }}"
        shell: "{{ user_shell }}"
        create_home: yes
        password: "{{ user_passwd | password_hash('sha512') }}"
        update_password: on_create
        groups: "{{ sudo_group if user_sudo | default(false) else omit }}"
        append: yes
        state: present

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "/home/{{ new_user }}/.ssh"
        state: directory
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: '0700'

    - name: Add authorized SSH key
      ansible.builtin.authorized_key:
        user: "{{ new_user }}"
        key: "{{ user_ssh_key }}"
        state: present